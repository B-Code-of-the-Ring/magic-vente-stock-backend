e2ed66b0494d9b44f4d2ba2866be8b97
"use strict";

var __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {
  if (k2 === undefined) k2 = k;
  var desc = Object.getOwnPropertyDescriptor(m, k);
  if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
    desc = {
      enumerable: true,
      get: function () {
        return m[k];
      }
    };
  }
  Object.defineProperty(o, k2, desc);
} : function (o, m, k, k2) {
  if (k2 === undefined) k2 = k;
  o[k2] = m[k];
});
var __exportStar = this && this.__exportStar || function (m, exports) {
  for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);
};
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DomHandler = void 0;
var domelementtype_1 = require("domelementtype");
var node_js_1 = require("./node.js");
__exportStar(require("./node.js"), exports);
// Default options
var defaultOpts = {
  withStartIndices: false,
  withEndIndices: false,
  xmlMode: false
};
var DomHandler = /** @class */function () {
  /**
   * @param callback Called once parsing has completed.
   * @param options Settings for the handler.
   * @param elementCB Callback whenever a tag is closed.
   */
  function DomHandler(callback, options, elementCB) {
    /** The elements of the DOM */
    this.dom = [];
    /** The root element for the DOM */
    this.root = new node_js_1.Document(this.dom);
    /** Indicated whether parsing has been completed. */
    this.done = false;
    /** Stack of open tags. */
    this.tagStack = [this.root];
    /** A data node that is still being written to. */
    this.lastNode = null;
    /** Reference to the parser instance. Used for location information. */
    this.parser = null;
    // Make it possible to skip arguments, for backwards-compatibility
    if (typeof options === "function") {
      elementCB = options;
      options = defaultOpts;
    }
    if (typeof callback === "object") {
      options = callback;
      callback = undefined;
    }
    this.callback = callback !== null && callback !== void 0 ? callback : null;
    this.options = options !== null && options !== void 0 ? options : defaultOpts;
    this.elementCB = elementCB !== null && elementCB !== void 0 ? elementCB : null;
  }
  DomHandler.prototype.onparserinit = function (parser) {
    this.parser = parser;
  };
  // Resets the handler back to starting state
  DomHandler.prototype.onreset = function () {
    this.dom = [];
    this.root = new node_js_1.Document(this.dom);
    this.done = false;
    this.tagStack = [this.root];
    this.lastNode = null;
    this.parser = null;
  };
  // Signals the handler that parsing is done
  DomHandler.prototype.onend = function () {
    if (this.done) return;
    this.done = true;
    this.parser = null;
    this.handleCallback(null);
  };
  DomHandler.prototype.onerror = function (error) {
    this.handleCallback(error);
  };
  DomHandler.prototype.onclosetag = function () {
    this.lastNode = null;
    var elem = this.tagStack.pop();
    if (this.options.withEndIndices) {
      elem.endIndex = this.parser.endIndex;
    }
    if (this.elementCB) this.elementCB(elem);
  };
  DomHandler.prototype.onopentag = function (name, attribs) {
    var type = this.options.xmlMode ? domelementtype_1.ElementType.Tag : undefined;
    var element = new node_js_1.Element(name, attribs, undefined, type);
    this.addNode(element);
    this.tagStack.push(element);
  };
  DomHandler.prototype.ontext = function (data) {
    var lastNode = this.lastNode;
    if (lastNode && lastNode.type === domelementtype_1.ElementType.Text) {
      lastNode.data += data;
      if (this.options.withEndIndices) {
        lastNode.endIndex = this.parser.endIndex;
      }
    } else {
      var node = new node_js_1.Text(data);
      this.addNode(node);
      this.lastNode = node;
    }
  };
  DomHandler.prototype.oncomment = function (data) {
    if (this.lastNode && this.lastNode.type === domelementtype_1.ElementType.Comment) {
      this.lastNode.data += data;
      return;
    }
    var node = new node_js_1.Comment(data);
    this.addNode(node);
    this.lastNode = node;
  };
  DomHandler.prototype.oncommentend = function () {
    this.lastNode = null;
  };
  DomHandler.prototype.oncdatastart = function () {
    var text = new node_js_1.Text("");
    var node = new node_js_1.CDATA([text]);
    this.addNode(node);
    text.parent = node;
    this.lastNode = text;
  };
  DomHandler.prototype.oncdataend = function () {
    this.lastNode = null;
  };
  DomHandler.prototype.onprocessinginstruction = function (name, data) {
    var node = new node_js_1.ProcessingInstruction(name, data);
    this.addNode(node);
  };
  DomHandler.prototype.handleCallback = function (error) {
    if (typeof this.callback === "function") {
      this.callback(error, this.dom);
    } else if (error) {
      throw error;
    }
  };
  DomHandler.prototype.addNode = function (node) {
    var parent = this.tagStack[this.tagStack.length - 1];
    var previousSibling = parent.children[parent.children.length - 1];
    if (this.options.withStartIndices) {
      node.startIndex = this.parser.startIndex;
    }
    if (this.options.withEndIndices) {
      node.endIndex = this.parser.endIndex;
    }
    parent.children.push(node);
    if (previousSibling) {
      node.prev = previousSibling;
      previousSibling.next = node;
    }
    node.parent = parent;
    this.lastNode = null;
  };
  return DomHandler;
}();
exports.DomHandler = DomHandler;
exports.default = DomHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfX2NyZWF0ZUJpbmRpbmciLCJPYmplY3QiLCJjcmVhdGUiLCJvIiwibSIsImsiLCJrMiIsInVuZGVmaW5lZCIsImRlc2MiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJfX2VzTW9kdWxlIiwid3JpdGFibGUiLCJjb25maWd1cmFibGUiLCJlbnVtZXJhYmxlIiwiZ2V0IiwiZGVmaW5lUHJvcGVydHkiLCJfX2V4cG9ydFN0YXIiLCJleHBvcnRzIiwicCIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsInZhbHVlIiwiRG9tSGFuZGxlciIsImRvbWVsZW1lbnR0eXBlXzEiLCJyZXF1aXJlIiwibm9kZV9qc18xIiwiZGVmYXVsdE9wdHMiLCJ3aXRoU3RhcnRJbmRpY2VzIiwid2l0aEVuZEluZGljZXMiLCJ4bWxNb2RlIiwiY2FsbGJhY2siLCJvcHRpb25zIiwiZWxlbWVudENCIiwiZG9tIiwicm9vdCIsIkRvY3VtZW50IiwiZG9uZSIsInRhZ1N0YWNrIiwibGFzdE5vZGUiLCJwYXJzZXIiLCJvbnBhcnNlcmluaXQiLCJvbnJlc2V0Iiwib25lbmQiLCJoYW5kbGVDYWxsYmFjayIsIm9uZXJyb3IiLCJlcnJvciIsIm9uY2xvc2V0YWciLCJlbGVtIiwicG9wIiwiZW5kSW5kZXgiLCJvbm9wZW50YWciLCJuYW1lIiwiYXR0cmlicyIsInR5cGUiLCJFbGVtZW50VHlwZSIsIlRhZyIsImVsZW1lbnQiLCJFbGVtZW50IiwiYWRkTm9kZSIsInB1c2giLCJvbnRleHQiLCJkYXRhIiwiVGV4dCIsIm5vZGUiLCJvbmNvbW1lbnQiLCJDb21tZW50Iiwib25jb21tZW50ZW5kIiwib25jZGF0YXN0YXJ0IiwidGV4dCIsIkNEQVRBIiwicGFyZW50Iiwib25jZGF0YWVuZCIsIm9ucHJvY2Vzc2luZ2luc3RydWN0aW9uIiwiUHJvY2Vzc2luZ0luc3RydWN0aW9uIiwibGVuZ3RoIiwicHJldmlvdXNTaWJsaW5nIiwiY2hpbGRyZW4iLCJzdGFydEluZGV4IiwicHJldiIsIm5leHQiLCJkZWZhdWx0Il0sInNvdXJjZXMiOlsiaW5kZXguanMiXSwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG52YXIgX19jcmVhdGVCaW5kaW5nID0gKHRoaXMgJiYgdGhpcy5fX2NyZWF0ZUJpbmRpbmcpIHx8IChPYmplY3QuY3JlYXRlID8gKGZ1bmN0aW9uKG8sIG0sIGssIGsyKSB7XG4gICAgaWYgKGsyID09PSB1bmRlZmluZWQpIGsyID0gaztcbiAgICB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IobSwgayk7XG4gICAgaWYgKCFkZXNjIHx8IChcImdldFwiIGluIGRlc2MgPyAhbS5fX2VzTW9kdWxlIDogZGVzYy53cml0YWJsZSB8fCBkZXNjLmNvbmZpZ3VyYWJsZSkpIHtcbiAgICAgIGRlc2MgPSB7IGVudW1lcmFibGU6IHRydWUsIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBtW2tdOyB9IH07XG4gICAgfVxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCBrMiwgZGVzYyk7XG59KSA6IChmdW5jdGlvbihvLCBtLCBrLCBrMikge1xuICAgIGlmIChrMiA9PT0gdW5kZWZpbmVkKSBrMiA9IGs7XG4gICAgb1trMl0gPSBtW2tdO1xufSkpO1xudmFyIF9fZXhwb3J0U3RhciA9ICh0aGlzICYmIHRoaXMuX19leHBvcnRTdGFyKSB8fCBmdW5jdGlvbihtLCBleHBvcnRzKSB7XG4gICAgZm9yICh2YXIgcCBpbiBtKSBpZiAocCAhPT0gXCJkZWZhdWx0XCIgJiYgIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChleHBvcnRzLCBwKSkgX19jcmVhdGVCaW5kaW5nKGV4cG9ydHMsIG0sIHApO1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmV4cG9ydHMuRG9tSGFuZGxlciA9IHZvaWQgMDtcbnZhciBkb21lbGVtZW50dHlwZV8xID0gcmVxdWlyZShcImRvbWVsZW1lbnR0eXBlXCIpO1xudmFyIG5vZGVfanNfMSA9IHJlcXVpcmUoXCIuL25vZGUuanNcIik7XG5fX2V4cG9ydFN0YXIocmVxdWlyZShcIi4vbm9kZS5qc1wiKSwgZXhwb3J0cyk7XG4vLyBEZWZhdWx0IG9wdGlvbnNcbnZhciBkZWZhdWx0T3B0cyA9IHtcbiAgICB3aXRoU3RhcnRJbmRpY2VzOiBmYWxzZSxcbiAgICB3aXRoRW5kSW5kaWNlczogZmFsc2UsXG4gICAgeG1sTW9kZTogZmFsc2UsXG59O1xudmFyIERvbUhhbmRsZXIgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XG4gICAgLyoqXG4gICAgICogQHBhcmFtIGNhbGxiYWNrIENhbGxlZCBvbmNlIHBhcnNpbmcgaGFzIGNvbXBsZXRlZC5cbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBTZXR0aW5ncyBmb3IgdGhlIGhhbmRsZXIuXG4gICAgICogQHBhcmFtIGVsZW1lbnRDQiBDYWxsYmFjayB3aGVuZXZlciBhIHRhZyBpcyBjbG9zZWQuXG4gICAgICovXG4gICAgZnVuY3Rpb24gRG9tSGFuZGxlcihjYWxsYmFjaywgb3B0aW9ucywgZWxlbWVudENCKSB7XG4gICAgICAgIC8qKiBUaGUgZWxlbWVudHMgb2YgdGhlIERPTSAqL1xuICAgICAgICB0aGlzLmRvbSA9IFtdO1xuICAgICAgICAvKiogVGhlIHJvb3QgZWxlbWVudCBmb3IgdGhlIERPTSAqL1xuICAgICAgICB0aGlzLnJvb3QgPSBuZXcgbm9kZV9qc18xLkRvY3VtZW50KHRoaXMuZG9tKTtcbiAgICAgICAgLyoqIEluZGljYXRlZCB3aGV0aGVyIHBhcnNpbmcgaGFzIGJlZW4gY29tcGxldGVkLiAqL1xuICAgICAgICB0aGlzLmRvbmUgPSBmYWxzZTtcbiAgICAgICAgLyoqIFN0YWNrIG9mIG9wZW4gdGFncy4gKi9cbiAgICAgICAgdGhpcy50YWdTdGFjayA9IFt0aGlzLnJvb3RdO1xuICAgICAgICAvKiogQSBkYXRhIG5vZGUgdGhhdCBpcyBzdGlsbCBiZWluZyB3cml0dGVuIHRvLiAqL1xuICAgICAgICB0aGlzLmxhc3ROb2RlID0gbnVsbDtcbiAgICAgICAgLyoqIFJlZmVyZW5jZSB0byB0aGUgcGFyc2VyIGluc3RhbmNlLiBVc2VkIGZvciBsb2NhdGlvbiBpbmZvcm1hdGlvbi4gKi9cbiAgICAgICAgdGhpcy5wYXJzZXIgPSBudWxsO1xuICAgICAgICAvLyBNYWtlIGl0IHBvc3NpYmxlIHRvIHNraXAgYXJndW1lbnRzLCBmb3IgYmFja3dhcmRzLWNvbXBhdGliaWxpdHlcbiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgIGVsZW1lbnRDQiA9IG9wdGlvbnM7XG4gICAgICAgICAgICBvcHRpb25zID0gZGVmYXVsdE9wdHM7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICAgb3B0aW9ucyA9IGNhbGxiYWNrO1xuICAgICAgICAgICAgY2FsbGJhY2sgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrICE9PSBudWxsICYmIGNhbGxiYWNrICE9PSB2b2lkIDAgPyBjYWxsYmFjayA6IG51bGw7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgIT09IG51bGwgJiYgb3B0aW9ucyAhPT0gdm9pZCAwID8gb3B0aW9ucyA6IGRlZmF1bHRPcHRzO1xuICAgICAgICB0aGlzLmVsZW1lbnRDQiA9IGVsZW1lbnRDQiAhPT0gbnVsbCAmJiBlbGVtZW50Q0IgIT09IHZvaWQgMCA/IGVsZW1lbnRDQiA6IG51bGw7XG4gICAgfVxuICAgIERvbUhhbmRsZXIucHJvdG90eXBlLm9ucGFyc2VyaW5pdCA9IGZ1bmN0aW9uIChwYXJzZXIpIHtcbiAgICAgICAgdGhpcy5wYXJzZXIgPSBwYXJzZXI7XG4gICAgfTtcbiAgICAvLyBSZXNldHMgdGhlIGhhbmRsZXIgYmFjayB0byBzdGFydGluZyBzdGF0ZVxuICAgIERvbUhhbmRsZXIucHJvdG90eXBlLm9ucmVzZXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHRoaXMuZG9tID0gW107XG4gICAgICAgIHRoaXMucm9vdCA9IG5ldyBub2RlX2pzXzEuRG9jdW1lbnQodGhpcy5kb20pO1xuICAgICAgICB0aGlzLmRvbmUgPSBmYWxzZTtcbiAgICAgICAgdGhpcy50YWdTdGFjayA9IFt0aGlzLnJvb3RdO1xuICAgICAgICB0aGlzLmxhc3ROb2RlID0gbnVsbDtcbiAgICAgICAgdGhpcy5wYXJzZXIgPSBudWxsO1xuICAgIH07XG4gICAgLy8gU2lnbmFscyB0aGUgaGFuZGxlciB0aGF0IHBhcnNpbmcgaXMgZG9uZVxuICAgIERvbUhhbmRsZXIucHJvdG90eXBlLm9uZW5kID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAodGhpcy5kb25lKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB0aGlzLmRvbmUgPSB0cnVlO1xuICAgICAgICB0aGlzLnBhcnNlciA9IG51bGw7XG4gICAgICAgIHRoaXMuaGFuZGxlQ2FsbGJhY2sobnVsbCk7XG4gICAgfTtcbiAgICBEb21IYW5kbGVyLnByb3RvdHlwZS5vbmVycm9yID0gZnVuY3Rpb24gKGVycm9yKSB7XG4gICAgICAgIHRoaXMuaGFuZGxlQ2FsbGJhY2soZXJyb3IpO1xuICAgIH07XG4gICAgRG9tSGFuZGxlci5wcm90b3R5cGUub25jbG9zZXRhZyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy5sYXN0Tm9kZSA9IG51bGw7XG4gICAgICAgIHZhciBlbGVtID0gdGhpcy50YWdTdGFjay5wb3AoKTtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy53aXRoRW5kSW5kaWNlcykge1xuICAgICAgICAgICAgZWxlbS5lbmRJbmRleCA9IHRoaXMucGFyc2VyLmVuZEluZGV4O1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmVsZW1lbnRDQilcbiAgICAgICAgICAgIHRoaXMuZWxlbWVudENCKGVsZW0pO1xuICAgIH07XG4gICAgRG9tSGFuZGxlci5wcm90b3R5cGUub25vcGVudGFnID0gZnVuY3Rpb24gKG5hbWUsIGF0dHJpYnMpIHtcbiAgICAgICAgdmFyIHR5cGUgPSB0aGlzLm9wdGlvbnMueG1sTW9kZSA/IGRvbWVsZW1lbnR0eXBlXzEuRWxlbWVudFR5cGUuVGFnIDogdW5kZWZpbmVkO1xuICAgICAgICB2YXIgZWxlbWVudCA9IG5ldyBub2RlX2pzXzEuRWxlbWVudChuYW1lLCBhdHRyaWJzLCB1bmRlZmluZWQsIHR5cGUpO1xuICAgICAgICB0aGlzLmFkZE5vZGUoZWxlbWVudCk7XG4gICAgICAgIHRoaXMudGFnU3RhY2sucHVzaChlbGVtZW50KTtcbiAgICB9O1xuICAgIERvbUhhbmRsZXIucHJvdG90eXBlLm9udGV4dCA9IGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgIHZhciBsYXN0Tm9kZSA9IHRoaXMubGFzdE5vZGU7XG4gICAgICAgIGlmIChsYXN0Tm9kZSAmJiBsYXN0Tm9kZS50eXBlID09PSBkb21lbGVtZW50dHlwZV8xLkVsZW1lbnRUeXBlLlRleHQpIHtcbiAgICAgICAgICAgIGxhc3ROb2RlLmRhdGEgKz0gZGF0YTtcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMud2l0aEVuZEluZGljZXMpIHtcbiAgICAgICAgICAgICAgICBsYXN0Tm9kZS5lbmRJbmRleCA9IHRoaXMucGFyc2VyLmVuZEluZGV4O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdmFyIG5vZGUgPSBuZXcgbm9kZV9qc18xLlRleHQoZGF0YSk7XG4gICAgICAgICAgICB0aGlzLmFkZE5vZGUobm9kZSk7XG4gICAgICAgICAgICB0aGlzLmxhc3ROb2RlID0gbm9kZTtcbiAgICAgICAgfVxuICAgIH07XG4gICAgRG9tSGFuZGxlci5wcm90b3R5cGUub25jb21tZW50ID0gZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgaWYgKHRoaXMubGFzdE5vZGUgJiYgdGhpcy5sYXN0Tm9kZS50eXBlID09PSBkb21lbGVtZW50dHlwZV8xLkVsZW1lbnRUeXBlLkNvbW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMubGFzdE5vZGUuZGF0YSArPSBkYXRhO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHZhciBub2RlID0gbmV3IG5vZGVfanNfMS5Db21tZW50KGRhdGEpO1xuICAgICAgICB0aGlzLmFkZE5vZGUobm9kZSk7XG4gICAgICAgIHRoaXMubGFzdE5vZGUgPSBub2RlO1xuICAgIH07XG4gICAgRG9tSGFuZGxlci5wcm90b3R5cGUub25jb21tZW50ZW5kID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLmxhc3ROb2RlID0gbnVsbDtcbiAgICB9O1xuICAgIERvbUhhbmRsZXIucHJvdG90eXBlLm9uY2RhdGFzdGFydCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIHRleHQgPSBuZXcgbm9kZV9qc18xLlRleHQoXCJcIik7XG4gICAgICAgIHZhciBub2RlID0gbmV3IG5vZGVfanNfMS5DREFUQShbdGV4dF0pO1xuICAgICAgICB0aGlzLmFkZE5vZGUobm9kZSk7XG4gICAgICAgIHRleHQucGFyZW50ID0gbm9kZTtcbiAgICAgICAgdGhpcy5sYXN0Tm9kZSA9IHRleHQ7XG4gICAgfTtcbiAgICBEb21IYW5kbGVyLnByb3RvdHlwZS5vbmNkYXRhZW5kID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLmxhc3ROb2RlID0gbnVsbDtcbiAgICB9O1xuICAgIERvbUhhbmRsZXIucHJvdG90eXBlLm9ucHJvY2Vzc2luZ2luc3RydWN0aW9uID0gZnVuY3Rpb24gKG5hbWUsIGRhdGEpIHtcbiAgICAgICAgdmFyIG5vZGUgPSBuZXcgbm9kZV9qc18xLlByb2Nlc3NpbmdJbnN0cnVjdGlvbihuYW1lLCBkYXRhKTtcbiAgICAgICAgdGhpcy5hZGROb2RlKG5vZGUpO1xuICAgIH07XG4gICAgRG9tSGFuZGxlci5wcm90b3R5cGUuaGFuZGxlQ2FsbGJhY2sgPSBmdW5jdGlvbiAoZXJyb3IpIHtcbiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmNhbGxiYWNrID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2soZXJyb3IsIHRoaXMuZG9tKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIERvbUhhbmRsZXIucHJvdG90eXBlLmFkZE5vZGUgPSBmdW5jdGlvbiAobm9kZSkge1xuICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy50YWdTdGFja1t0aGlzLnRhZ1N0YWNrLmxlbmd0aCAtIDFdO1xuICAgICAgICB2YXIgcHJldmlvdXNTaWJsaW5nID0gcGFyZW50LmNoaWxkcmVuW3BhcmVudC5jaGlsZHJlbi5sZW5ndGggLSAxXTtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy53aXRoU3RhcnRJbmRpY2VzKSB7XG4gICAgICAgICAgICBub2RlLnN0YXJ0SW5kZXggPSB0aGlzLnBhcnNlci5zdGFydEluZGV4O1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMud2l0aEVuZEluZGljZXMpIHtcbiAgICAgICAgICAgIG5vZGUuZW5kSW5kZXggPSB0aGlzLnBhcnNlci5lbmRJbmRleDtcbiAgICAgICAgfVxuICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChub2RlKTtcbiAgICAgICAgaWYgKHByZXZpb3VzU2libGluZykge1xuICAgICAgICAgICAgbm9kZS5wcmV2ID0gcHJldmlvdXNTaWJsaW5nO1xuICAgICAgICAgICAgcHJldmlvdXNTaWJsaW5nLm5leHQgPSBub2RlO1xuICAgICAgICB9XG4gICAgICAgIG5vZGUucGFyZW50ID0gcGFyZW50O1xuICAgICAgICB0aGlzLmxhc3ROb2RlID0gbnVsbDtcbiAgICB9O1xuICAgIHJldHVybiBEb21IYW5kbGVyO1xufSgpKTtcbmV4cG9ydHMuRG9tSGFuZGxlciA9IERvbUhhbmRsZXI7XG5leHBvcnRzLmRlZmF1bHQgPSBEb21IYW5kbGVyO1xuIl0sIm1hcHBpbmdzIjoiQUFBQSxZQUFZOztBQUNaLElBQUlBLGVBQWUsR0FBSSxJQUFJLElBQUksSUFBSSxDQUFDQSxlQUFlLEtBQU1DLE1BQU0sQ0FBQ0MsTUFBTSxHQUFJLFVBQVNDLENBQUMsRUFBRUMsQ0FBQyxFQUFFQyxDQUFDLEVBQUVDLEVBQUUsRUFBRTtFQUM1RixJQUFJQSxFQUFFLEtBQUtDLFNBQVMsRUFBRUQsRUFBRSxHQUFHRCxDQUFDO0VBQzVCLElBQUlHLElBQUksR0FBR1AsTUFBTSxDQUFDUSx3QkFBd0IsQ0FBQ0wsQ0FBQyxFQUFFQyxDQUFDLENBQUM7RUFDaEQsSUFBSSxDQUFDRyxJQUFJLEtBQUssS0FBSyxJQUFJQSxJQUFJLEdBQUcsQ0FBQ0osQ0FBQyxDQUFDTSxVQUFVLEdBQUdGLElBQUksQ0FBQ0csUUFBUSxJQUFJSCxJQUFJLENBQUNJLFlBQVksQ0FBQyxFQUFFO0lBQ2pGSixJQUFJLEdBQUc7TUFBRUssVUFBVSxFQUFFLElBQUk7TUFBRUMsR0FBRyxFQUFFLFNBQUFBLENBQUEsRUFBVztRQUFFLE9BQU9WLENBQUMsQ0FBQ0MsQ0FBQyxDQUFDO01BQUU7SUFBRSxDQUFDO0VBQy9EO0VBQ0FKLE1BQU0sQ0FBQ2MsY0FBYyxDQUFDWixDQUFDLEVBQUVHLEVBQUUsRUFBRUUsSUFBSSxDQUFDO0FBQ3RDLENBQUMsR0FBSyxVQUFTTCxDQUFDLEVBQUVDLENBQUMsRUFBRUMsQ0FBQyxFQUFFQyxFQUFFLEVBQUU7RUFDeEIsSUFBSUEsRUFBRSxLQUFLQyxTQUFTLEVBQUVELEVBQUUsR0FBR0QsQ0FBQztFQUM1QkYsQ0FBQyxDQUFDRyxFQUFFLENBQUMsR0FBR0YsQ0FBQyxDQUFDQyxDQUFDLENBQUM7QUFDaEIsQ0FBRSxDQUFDO0FBQ0gsSUFBSVcsWUFBWSxHQUFJLElBQUksSUFBSSxJQUFJLENBQUNBLFlBQVksSUFBSyxVQUFTWixDQUFDLEVBQUVhLE9BQU8sRUFBRTtFQUNuRSxLQUFLLElBQUlDLENBQUMsSUFBSWQsQ0FBQyxFQUFFLElBQUljLENBQUMsS0FBSyxTQUFTLElBQUksQ0FBQ2pCLE1BQU0sQ0FBQ2tCLFNBQVMsQ0FBQ0MsY0FBYyxDQUFDQyxJQUFJLENBQUNKLE9BQU8sRUFBRUMsQ0FBQyxDQUFDLEVBQUVsQixlQUFlLENBQUNpQixPQUFPLEVBQUViLENBQUMsRUFBRWMsQ0FBQyxDQUFDO0FBQzdILENBQUM7QUFDRGpCLE1BQU0sQ0FBQ2MsY0FBYyxDQUFDRSxPQUFPLEVBQUUsWUFBWSxFQUFFO0VBQUVLLEtBQUssRUFBRTtBQUFLLENBQUMsQ0FBQztBQUM3REwsT0FBTyxDQUFDTSxVQUFVLEdBQUcsS0FBSyxDQUFDO0FBQzNCLElBQUlDLGdCQUFnQixHQUFHQyxPQUFPLENBQUMsZ0JBQWdCLENBQUM7QUFDaEQsSUFBSUMsU0FBUyxHQUFHRCxPQUFPLENBQUMsV0FBVyxDQUFDO0FBQ3BDVCxZQUFZLENBQUNTLE9BQU8sQ0FBQyxXQUFXLENBQUMsRUFBRVIsT0FBTyxDQUFDO0FBQzNDO0FBQ0EsSUFBSVUsV0FBVyxHQUFHO0VBQ2RDLGdCQUFnQixFQUFFLEtBQUs7RUFDdkJDLGNBQWMsRUFBRSxLQUFLO0VBQ3JCQyxPQUFPLEVBQUU7QUFDYixDQUFDO0FBQ0QsSUFBSVAsVUFBVSxHQUFHLGFBQWUsWUFBWTtFQUN4QztBQUNKO0FBQ0E7QUFDQTtBQUNBO0VBQ0ksU0FBU0EsVUFBVUEsQ0FBQ1EsUUFBUSxFQUFFQyxPQUFPLEVBQUVDLFNBQVMsRUFBRTtJQUM5QztJQUNBLElBQUksQ0FBQ0MsR0FBRyxHQUFHLEVBQUU7SUFDYjtJQUNBLElBQUksQ0FBQ0MsSUFBSSxHQUFHLElBQUlULFNBQVMsQ0FBQ1UsUUFBUSxDQUFDLElBQUksQ0FBQ0YsR0FBRyxDQUFDO0lBQzVDO0lBQ0EsSUFBSSxDQUFDRyxJQUFJLEdBQUcsS0FBSztJQUNqQjtJQUNBLElBQUksQ0FBQ0MsUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFDSCxJQUFJLENBQUM7SUFDM0I7SUFDQSxJQUFJLENBQUNJLFFBQVEsR0FBRyxJQUFJO0lBQ3BCO0lBQ0EsSUFBSSxDQUFDQyxNQUFNLEdBQUcsSUFBSTtJQUNsQjtJQUNBLElBQUksT0FBT1IsT0FBTyxLQUFLLFVBQVUsRUFBRTtNQUMvQkMsU0FBUyxHQUFHRCxPQUFPO01BQ25CQSxPQUFPLEdBQUdMLFdBQVc7SUFDekI7SUFDQSxJQUFJLE9BQU9JLFFBQVEsS0FBSyxRQUFRLEVBQUU7TUFDOUJDLE9BQU8sR0FBR0QsUUFBUTtNQUNsQkEsUUFBUSxHQUFHeEIsU0FBUztJQUN4QjtJQUNBLElBQUksQ0FBQ3dCLFFBQVEsR0FBR0EsUUFBUSxLQUFLLElBQUksSUFBSUEsUUFBUSxLQUFLLEtBQUssQ0FBQyxHQUFHQSxRQUFRLEdBQUcsSUFBSTtJQUMxRSxJQUFJLENBQUNDLE9BQU8sR0FBR0EsT0FBTyxLQUFLLElBQUksSUFBSUEsT0FBTyxLQUFLLEtBQUssQ0FBQyxHQUFHQSxPQUFPLEdBQUdMLFdBQVc7SUFDN0UsSUFBSSxDQUFDTSxTQUFTLEdBQUdBLFNBQVMsS0FBSyxJQUFJLElBQUlBLFNBQVMsS0FBSyxLQUFLLENBQUMsR0FBR0EsU0FBUyxHQUFHLElBQUk7RUFDbEY7RUFDQVYsVUFBVSxDQUFDSixTQUFTLENBQUNzQixZQUFZLEdBQUcsVUFBVUQsTUFBTSxFQUFFO0lBQ2xELElBQUksQ0FBQ0EsTUFBTSxHQUFHQSxNQUFNO0VBQ3hCLENBQUM7RUFDRDtFQUNBakIsVUFBVSxDQUFDSixTQUFTLENBQUN1QixPQUFPLEdBQUcsWUFBWTtJQUN2QyxJQUFJLENBQUNSLEdBQUcsR0FBRyxFQUFFO0lBQ2IsSUFBSSxDQUFDQyxJQUFJLEdBQUcsSUFBSVQsU0FBUyxDQUFDVSxRQUFRLENBQUMsSUFBSSxDQUFDRixHQUFHLENBQUM7SUFDNUMsSUFBSSxDQUFDRyxJQUFJLEdBQUcsS0FBSztJQUNqQixJQUFJLENBQUNDLFFBQVEsR0FBRyxDQUFDLElBQUksQ0FBQ0gsSUFBSSxDQUFDO0lBQzNCLElBQUksQ0FBQ0ksUUFBUSxHQUFHLElBQUk7SUFDcEIsSUFBSSxDQUFDQyxNQUFNLEdBQUcsSUFBSTtFQUN0QixDQUFDO0VBQ0Q7RUFDQWpCLFVBQVUsQ0FBQ0osU0FBUyxDQUFDd0IsS0FBSyxHQUFHLFlBQVk7SUFDckMsSUFBSSxJQUFJLENBQUNOLElBQUksRUFDVDtJQUNKLElBQUksQ0FBQ0EsSUFBSSxHQUFHLElBQUk7SUFDaEIsSUFBSSxDQUFDRyxNQUFNLEdBQUcsSUFBSTtJQUNsQixJQUFJLENBQUNJLGNBQWMsQ0FBQyxJQUFJLENBQUM7RUFDN0IsQ0FBQztFQUNEckIsVUFBVSxDQUFDSixTQUFTLENBQUMwQixPQUFPLEdBQUcsVUFBVUMsS0FBSyxFQUFFO0lBQzVDLElBQUksQ0FBQ0YsY0FBYyxDQUFDRSxLQUFLLENBQUM7RUFDOUIsQ0FBQztFQUNEdkIsVUFBVSxDQUFDSixTQUFTLENBQUM0QixVQUFVLEdBQUcsWUFBWTtJQUMxQyxJQUFJLENBQUNSLFFBQVEsR0FBRyxJQUFJO0lBQ3BCLElBQUlTLElBQUksR0FBRyxJQUFJLENBQUNWLFFBQVEsQ0FBQ1csR0FBRyxDQUFDLENBQUM7SUFDOUIsSUFBSSxJQUFJLENBQUNqQixPQUFPLENBQUNILGNBQWMsRUFBRTtNQUM3Qm1CLElBQUksQ0FBQ0UsUUFBUSxHQUFHLElBQUksQ0FBQ1YsTUFBTSxDQUFDVSxRQUFRO0lBQ3hDO0lBQ0EsSUFBSSxJQUFJLENBQUNqQixTQUFTLEVBQ2QsSUFBSSxDQUFDQSxTQUFTLENBQUNlLElBQUksQ0FBQztFQUM1QixDQUFDO0VBQ0R6QixVQUFVLENBQUNKLFNBQVMsQ0FBQ2dDLFNBQVMsR0FBRyxVQUFVQyxJQUFJLEVBQUVDLE9BQU8sRUFBRTtJQUN0RCxJQUFJQyxJQUFJLEdBQUcsSUFBSSxDQUFDdEIsT0FBTyxDQUFDRixPQUFPLEdBQUdOLGdCQUFnQixDQUFDK0IsV0FBVyxDQUFDQyxHQUFHLEdBQUdqRCxTQUFTO0lBQzlFLElBQUlrRCxPQUFPLEdBQUcsSUFBSS9CLFNBQVMsQ0FBQ2dDLE9BQU8sQ0FBQ04sSUFBSSxFQUFFQyxPQUFPLEVBQUU5QyxTQUFTLEVBQUUrQyxJQUFJLENBQUM7SUFDbkUsSUFBSSxDQUFDSyxPQUFPLENBQUNGLE9BQU8sQ0FBQztJQUNyQixJQUFJLENBQUNuQixRQUFRLENBQUNzQixJQUFJLENBQUNILE9BQU8sQ0FBQztFQUMvQixDQUFDO0VBQ0RsQyxVQUFVLENBQUNKLFNBQVMsQ0FBQzBDLE1BQU0sR0FBRyxVQUFVQyxJQUFJLEVBQUU7SUFDMUMsSUFBSXZCLFFBQVEsR0FBRyxJQUFJLENBQUNBLFFBQVE7SUFDNUIsSUFBSUEsUUFBUSxJQUFJQSxRQUFRLENBQUNlLElBQUksS0FBSzlCLGdCQUFnQixDQUFDK0IsV0FBVyxDQUFDUSxJQUFJLEVBQUU7TUFDakV4QixRQUFRLENBQUN1QixJQUFJLElBQUlBLElBQUk7TUFDckIsSUFBSSxJQUFJLENBQUM5QixPQUFPLENBQUNILGNBQWMsRUFBRTtRQUM3QlUsUUFBUSxDQUFDVyxRQUFRLEdBQUcsSUFBSSxDQUFDVixNQUFNLENBQUNVLFFBQVE7TUFDNUM7SUFDSixDQUFDLE1BQ0k7TUFDRCxJQUFJYyxJQUFJLEdBQUcsSUFBSXRDLFNBQVMsQ0FBQ3FDLElBQUksQ0FBQ0QsSUFBSSxDQUFDO01BQ25DLElBQUksQ0FBQ0gsT0FBTyxDQUFDSyxJQUFJLENBQUM7TUFDbEIsSUFBSSxDQUFDekIsUUFBUSxHQUFHeUIsSUFBSTtJQUN4QjtFQUNKLENBQUM7RUFDRHpDLFVBQVUsQ0FBQ0osU0FBUyxDQUFDOEMsU0FBUyxHQUFHLFVBQVVILElBQUksRUFBRTtJQUM3QyxJQUFJLElBQUksQ0FBQ3ZCLFFBQVEsSUFBSSxJQUFJLENBQUNBLFFBQVEsQ0FBQ2UsSUFBSSxLQUFLOUIsZ0JBQWdCLENBQUMrQixXQUFXLENBQUNXLE9BQU8sRUFBRTtNQUM5RSxJQUFJLENBQUMzQixRQUFRLENBQUN1QixJQUFJLElBQUlBLElBQUk7TUFDMUI7SUFDSjtJQUNBLElBQUlFLElBQUksR0FBRyxJQUFJdEMsU0FBUyxDQUFDd0MsT0FBTyxDQUFDSixJQUFJLENBQUM7SUFDdEMsSUFBSSxDQUFDSCxPQUFPLENBQUNLLElBQUksQ0FBQztJQUNsQixJQUFJLENBQUN6QixRQUFRLEdBQUd5QixJQUFJO0VBQ3hCLENBQUM7RUFDRHpDLFVBQVUsQ0FBQ0osU0FBUyxDQUFDZ0QsWUFBWSxHQUFHLFlBQVk7SUFDNUMsSUFBSSxDQUFDNUIsUUFBUSxHQUFHLElBQUk7RUFDeEIsQ0FBQztFQUNEaEIsVUFBVSxDQUFDSixTQUFTLENBQUNpRCxZQUFZLEdBQUcsWUFBWTtJQUM1QyxJQUFJQyxJQUFJLEdBQUcsSUFBSTNDLFNBQVMsQ0FBQ3FDLElBQUksQ0FBQyxFQUFFLENBQUM7SUFDakMsSUFBSUMsSUFBSSxHQUFHLElBQUl0QyxTQUFTLENBQUM0QyxLQUFLLENBQUMsQ0FBQ0QsSUFBSSxDQUFDLENBQUM7SUFDdEMsSUFBSSxDQUFDVixPQUFPLENBQUNLLElBQUksQ0FBQztJQUNsQkssSUFBSSxDQUFDRSxNQUFNLEdBQUdQLElBQUk7SUFDbEIsSUFBSSxDQUFDekIsUUFBUSxHQUFHOEIsSUFBSTtFQUN4QixDQUFDO0VBQ0Q5QyxVQUFVLENBQUNKLFNBQVMsQ0FBQ3FELFVBQVUsR0FBRyxZQUFZO0lBQzFDLElBQUksQ0FBQ2pDLFFBQVEsR0FBRyxJQUFJO0VBQ3hCLENBQUM7RUFDRGhCLFVBQVUsQ0FBQ0osU0FBUyxDQUFDc0QsdUJBQXVCLEdBQUcsVUFBVXJCLElBQUksRUFBRVUsSUFBSSxFQUFFO0lBQ2pFLElBQUlFLElBQUksR0FBRyxJQUFJdEMsU0FBUyxDQUFDZ0QscUJBQXFCLENBQUN0QixJQUFJLEVBQUVVLElBQUksQ0FBQztJQUMxRCxJQUFJLENBQUNILE9BQU8sQ0FBQ0ssSUFBSSxDQUFDO0VBQ3RCLENBQUM7RUFDRHpDLFVBQVUsQ0FBQ0osU0FBUyxDQUFDeUIsY0FBYyxHQUFHLFVBQVVFLEtBQUssRUFBRTtJQUNuRCxJQUFJLE9BQU8sSUFBSSxDQUFDZixRQUFRLEtBQUssVUFBVSxFQUFFO01BQ3JDLElBQUksQ0FBQ0EsUUFBUSxDQUFDZSxLQUFLLEVBQUUsSUFBSSxDQUFDWixHQUFHLENBQUM7SUFDbEMsQ0FBQyxNQUNJLElBQUlZLEtBQUssRUFBRTtNQUNaLE1BQU1BLEtBQUs7SUFDZjtFQUNKLENBQUM7RUFDRHZCLFVBQVUsQ0FBQ0osU0FBUyxDQUFDd0MsT0FBTyxHQUFHLFVBQVVLLElBQUksRUFBRTtJQUMzQyxJQUFJTyxNQUFNLEdBQUcsSUFBSSxDQUFDakMsUUFBUSxDQUFDLElBQUksQ0FBQ0EsUUFBUSxDQUFDcUMsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUNwRCxJQUFJQyxlQUFlLEdBQUdMLE1BQU0sQ0FBQ00sUUFBUSxDQUFDTixNQUFNLENBQUNNLFFBQVEsQ0FBQ0YsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUNqRSxJQUFJLElBQUksQ0FBQzNDLE9BQU8sQ0FBQ0osZ0JBQWdCLEVBQUU7TUFDL0JvQyxJQUFJLENBQUNjLFVBQVUsR0FBRyxJQUFJLENBQUN0QyxNQUFNLENBQUNzQyxVQUFVO0lBQzVDO0lBQ0EsSUFBSSxJQUFJLENBQUM5QyxPQUFPLENBQUNILGNBQWMsRUFBRTtNQUM3Qm1DLElBQUksQ0FBQ2QsUUFBUSxHQUFHLElBQUksQ0FBQ1YsTUFBTSxDQUFDVSxRQUFRO0lBQ3hDO0lBQ0FxQixNQUFNLENBQUNNLFFBQVEsQ0FBQ2pCLElBQUksQ0FBQ0ksSUFBSSxDQUFDO0lBQzFCLElBQUlZLGVBQWUsRUFBRTtNQUNqQlosSUFBSSxDQUFDZSxJQUFJLEdBQUdILGVBQWU7TUFDM0JBLGVBQWUsQ0FBQ0ksSUFBSSxHQUFHaEIsSUFBSTtJQUMvQjtJQUNBQSxJQUFJLENBQUNPLE1BQU0sR0FBR0EsTUFBTTtJQUNwQixJQUFJLENBQUNoQyxRQUFRLEdBQUcsSUFBSTtFQUN4QixDQUFDO0VBQ0QsT0FBT2hCLFVBQVU7QUFDckIsQ0FBQyxDQUFDLENBQUU7QUFDSk4sT0FBTyxDQUFDTSxVQUFVLEdBQUdBLFVBQVU7QUFDL0JOLE9BQU8sQ0FBQ2dFLE9BQU8sR0FBRzFELFVBQVUiLCJpZ25vcmVMaXN0IjpbXX0=