b487fb79802aa8ae75b02bea63b83f59
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const axios_1 = tslib_1.__importDefault(require("axios"));
const sinon_1 = tslib_1.__importDefault(require("sinon"));
const react_jhipster_1 = require("react-jhipster");
const toolkit_1 = require("@reduxjs/toolkit");
const authentication_1 = tslib_1.__importStar(require("app/shared/reducers/authentication"));
describe('Authentication reducer tests', () => {
    function isAccountEmpty(state) {
        return Object.keys(state.account).length === 0;
    }
    describe('Common tests', () => {
        it('should return the initial state', () => {
            const toTest = (0, authentication_1.default)(undefined, { type: '' });
            expect(toTest).toMatchObject({
                loading: false,
                isAuthenticated: false,
                errorMessage: null, // Errors returned from server side
                loginSuccess: false,
                loginError: false, // Errors returned from server side
                showModalLogin: false,
                redirectMessage: null,
            });
            expect(isAccountEmpty(toTest));
        });
    });
    describe('Requests', () => {
        it('should detect a request', () => {
            expect((0, authentication_1.default)(undefined, { type: authentication_1.authenticate.pending.type })).toMatchObject({
                loading: true,
            });
            expect((0, authentication_1.default)(undefined, { type: authentication_1.getAccount.pending.type })).toMatchObject({
                loading: true,
            });
        });
    });
    describe('Success', () => {
        it('should detect a success on login', () => {
            const toTest = (0, authentication_1.default)(undefined, { type: authentication_1.authenticate.fulfilled.type });
            expect(toTest).toMatchObject({
                loading: false,
                loginError: false,
                loginSuccess: true,
                showModalLogin: false,
            });
        });
        it('should detect a success on get session and be authenticated', () => {
            const payload = { data: { activated: true } };
            const toTest = (0, authentication_1.default)(undefined, { type: authentication_1.getAccount.fulfilled.type, payload });
            expect(toTest).toMatchObject({
                isAuthenticated: true,
                loading: false,
                account: payload.data,
            });
        });
        it('should detect a success on get session and not be authenticated', () => {
            const payload = { data: { activated: false } };
            const toTest = (0, authentication_1.default)(undefined, { type: authentication_1.getAccount.fulfilled.type, payload });
            expect(toTest).toMatchObject({
                isAuthenticated: false,
                loading: false,
                account: payload.data,
            });
        });
    });
    describe('Failure', () => {
        it('should detect a failure on login', () => {
            const error = { message: 'Something happened.' };
            const toTest = (0, authentication_1.default)(undefined, { type: authentication_1.authenticate.rejected.type, error });
            expect(toTest).toMatchObject({
                errorMessage: error.message,
                showModalLogin: true,
                loginError: true,
            });
            expect(isAccountEmpty(toTest));
        });
        it('should detect a failure', () => {
            const error = { message: 'Something happened.' };
            const toTest = (0, authentication_1.default)(undefined, { type: authentication_1.getAccount.rejected.type, error });
            expect(toTest).toMatchObject({
                loading: false,
                isAuthenticated: false,
                showModalLogin: true,
                errorMessage: error.message,
            });
            expect(isAccountEmpty(toTest));
        });
    });
    describe('Other cases', () => {
        it('should properly reset the current state when a logout is requested', () => {
            const toTest = (0, authentication_1.default)(undefined, (0, authentication_1.logoutSession)());
            expect(toTest).toMatchObject({
                loading: false,
                isAuthenticated: false,
                loginSuccess: false,
                loginError: false,
                showModalLogin: true,
                errorMessage: null,
                redirectMessage: null,
            });
            expect(isAccountEmpty(toTest));
        });
        it('should properly define an error message and change the current state to display the login modal', () => {
            const message = 'redirect me please';
            const toTest = (0, authentication_1.default)(undefined, (0, authentication_1.authError)(message));
            expect(toTest).toMatchObject({
                loading: false,
                isAuthenticated: false,
                loginSuccess: false,
                loginError: false,
                showModalLogin: true,
                errorMessage: null,
                redirectMessage: message,
            });
            expect(isAccountEmpty(toTest));
        });
        it('should clear authentication', () => {
            const toTest = (0, authentication_1.default)(Object.assign(Object.assign({}, authentication_1.initialState), { isAuthenticated: true }), (0, authentication_1.clearAuth)());
            expect(toTest).toMatchObject({
                loading: false,
                showModalLogin: true,
                isAuthenticated: false,
            });
        });
    });
    describe('Actions', () => {
        let store;
        const resolvedObject = { value: 'whatever' };
        const getState = jest.fn();
        const dispatch = jest.fn();
        const extra = {};
        beforeEach(() => {
            store = (0, toolkit_1.configureStore)({
                reducer: (state = [], action) => [...state, action],
            });
            axios_1.default.get = sinon_1.default.stub().returns(Promise.resolve(resolvedObject));
        });
        it('dispatches GET_SESSION_PENDING and GET_SESSION_FULFILLED actions', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const result = yield (0, authentication_1.getAccount)()(dispatch, getState, extra);
            const pendingAction = dispatch.mock.calls[0][0];
            expect(pendingAction.meta.requestStatus).toBe('pending');
            expect(authentication_1.getAccount.fulfilled.match(result)).toBe(true);
        }));
        it('dispatches LOGOUT actions', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            yield store.dispatch((0, authentication_1.logout)());
            expect(store.getState()).toEqual([expect.any(Object), expect.objectContaining((0, authentication_1.logoutSession)())]);
        }));
        it('dispatches CLEAR_AUTH actions', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            yield store.dispatch((0, authentication_1.clearAuthentication)('message'));
            expect(store.getState()).toEqual([expect.any(Object), expect.objectContaining((0, authentication_1.authError)('message')), (0, authentication_1.clearAuth)()]);
        }));
        it('dispatches LOGIN, GET_SESSION and SET_LOCALE success and request actions', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const loginResponse = { headers: { authorization: 'auth' } };
            axios_1.default.post = sinon_1.default.stub().returns(Promise.resolve(loginResponse));
            const result = yield (0, authentication_1.authenticate)('test', 'test')(dispatch, getState, extra);
            const pendingAction = dispatch.mock.calls[0][0];
            expect(pendingAction.meta.requestStatus).toBe('pending');
            expect(authentication_1.authenticate.fulfilled.match(result)).toBe(true);
        }));
    });
    describe('clearAuthToken', () => {
        let store;
        const reducer = (0, toolkit_1.createReducer)({ authentication: { account: { langKey: 'en' } } }, builder => {
            builder.addDefaultCase(() => { });
        });
        beforeEach(() => {
            store = (0, toolkit_1.configureStore)({
                reducer,
            });
        });
        it('clears the session token on clearAuthToken', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const AUTH_TOKEN_KEY = 'jhi-authenticationToken';
            const loginResponse = { headers: { authorization: 'Bearer TestToken' } };
            axios_1.default.post = sinon_1.default.stub().returns(Promise.resolve(loginResponse));
            yield store.dispatch((0, authentication_1.login)('test', 'test'));
            expect(react_jhipster_1.Storage.session.get(AUTH_TOKEN_KEY)).toBe('TestToken');
            expect(react_jhipster_1.Storage.local.get(AUTH_TOKEN_KEY)).toBe(undefined);
            (0, authentication_1.clearAuthToken)();
            expect(react_jhipster_1.Storage.session.get(AUTH_TOKEN_KEY)).toBe(undefined);
            expect(react_jhipster_1.Storage.local.get(AUTH_TOKEN_KEY)).toBe(undefined);
        }));
        it('clears the local storage token on clearAuthToken', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const AUTH_TOKEN_KEY = 'jhi-authenticationToken';
            const loginResponse = { headers: { authorization: 'Bearer TestToken' } };
            axios_1.default.post = sinon_1.default.stub().returns(Promise.resolve(loginResponse));
            yield store.dispatch((0, authentication_1.login)('user', 'user', true));
            expect(react_jhipster_1.Storage.session.get(AUTH_TOKEN_KEY)).toBe(undefined);
            expect(react_jhipster_1.Storage.local.get(AUTH_TOKEN_KEY)).toBe('TestToken');
            (0, authentication_1.clearAuthToken)();
            expect(react_jhipster_1.Storage.session.get(AUTH_TOKEN_KEY)).toBe(undefined);
            expect(react_jhipster_1.Storage.local.get(AUTH_TOKEN_KEY)).toBe(undefined);
        }));
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL3BjY28wNTYvRG9jdW1lbnRzL0NvdXJzIElUVS9yaWJvdWNob24vbWFnaWN2ZW50ZXN0b2NrL3NyYy9tYWluL3dlYmFwcC9hcHAvc2hhcmVkL3JlZHVjZXJzL2F1dGhlbnRpY2F0aW9uLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMERBQTBCO0FBQzFCLDBEQUEwQjtBQUMxQixtREFBeUM7QUFDekMsOENBQWlFO0FBRWpFLDZGQVc0QztBQUU1QyxRQUFRLENBQUMsOEJBQThCLEVBQUUsR0FBRyxFQUFFO0lBQzVDLFNBQVMsY0FBYyxDQUFDLEtBQUs7UUFDM0IsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFRCxRQUFRLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtRQUM1QixFQUFFLENBQUMsaUNBQWlDLEVBQUUsR0FBRyxFQUFFO1lBQ3pDLE1BQU0sTUFBTSxHQUFHLElBQUEsd0JBQWMsRUFBQyxTQUFTLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUN2RCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsYUFBYSxDQUFDO2dCQUMzQixPQUFPLEVBQUUsS0FBSztnQkFDZCxlQUFlLEVBQUUsS0FBSztnQkFDdEIsWUFBWSxFQUFFLElBQUksRUFBRSxtQ0FBbUM7Z0JBQ3ZELFlBQVksRUFBRSxLQUFLO2dCQUNuQixVQUFVLEVBQUUsS0FBSyxFQUFFLG1DQUFtQztnQkFDdEQsY0FBYyxFQUFFLEtBQUs7Z0JBQ3JCLGVBQWUsRUFBRSxJQUFJO2FBQ3RCLENBQUMsQ0FBQztZQUNILE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNqQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUU7UUFDeEIsRUFBRSxDQUFDLHlCQUF5QixFQUFFLEdB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WUFDNUQsSUFBQSwrQkFBYyxHQUFFLENBQUM7WUFDakIsTUFBTSxDQUFDLHdCQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUM1RCxNQUFNLENBQUMsd0JBQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzVELENBQUMsQ0FBQSxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9wY2NvMDU2L0RvY3VtZW50cy9Db3VycyBJVFUvcmlib3VjaG9uL21hZ2ljdmVudGVzdG9jay9zcmMvbWFpbi93ZWJhcHAvYXBwL3NoYXJlZC9yZWR1Y2Vycy9hdXRoZW50aWNhdGlvbi5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XG5pbXBvcnQgc2lub24gZnJvbSAnc2lub24nO1xuaW1wb3J0IHsgU3RvcmFnZSB9IGZyb20gJ3JlYWN0LWpoaXBzdGVyJztcbmltcG9ydCB7IGNvbmZpZ3VyZVN0b3JlLCBjcmVhdGVSZWR1Y2VyIH0gZnJvbSAnQHJlZHV4anMvdG9vbGtpdCc7XG5cbmltcG9ydCBhdXRoZW50aWNhdGlvbiwge1xuICBnZXRBY2NvdW50LFxuICBhdXRoZW50aWNhdGUsXG4gIGxvZ2luLFxuICBjbGVhckF1dGhlbnRpY2F0aW9uLFxuICBsb2dvdXQsXG4gIGxvZ291dFNlc3Npb24sXG4gIGNsZWFyQXV0aFRva2VuLFxuICBhdXRoRXJyb3IsXG4gIGNsZWFyQXV0aCxcbiAgaW5pdGlhbFN0YXRlLFxufSBmcm9tICdhcHAvc2hhcmVkL3JlZHVjZXJzL2F1dGhlbnRpY2F0aW9uJztcblxuZGVzY3JpYmUoJ0F1dGhlbnRpY2F0aW9uIHJlZHVjZXIgdGVzdHMnLCAoKSA9PiB7XG4gIGZ1bmN0aW9uIGlzQWNjb3VudEVtcHR5KHN0YXRlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHN0YXRlLmFjY291bnQpLmxlbmd0aCA9PT0gMDtcbiAgfVxuXG4gIGRlc2NyaWJlKCdDb21tb24gdGVzdHMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdGhlIGluaXRpYWwgc3RhdGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCB0b1Rlc3QgPSBhdXRoZW50aWNhdGlvbih1bmRlZmluZWQsIHsgdHlwZTogJycgfSk7XG4gICAgICBleHBlY3QodG9UZXN0KS50b01hdGNoT2JqZWN0KHtcbiAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICAgIGlzQXV0aGVudGljYXRlZDogZmFsc2UsXG4gICAgICAgIGVycm9yTWVzc2FnZTogbnVsbCwgLy8gRXJyb3JzIHJldHVybmVkIGZyb20gc2VydmVyIHNpZGVcbiAgICAgICAgbG9naW5TdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbG9naW5FcnJvcjogZmFsc2UsIC8vIEVycm9ycyByZXR1cm5lZCBmcm9tIHNlcnZlciBzaWRlXG4gICAgICAgIHNob3dNb2RhbExvZ2luOiBmYWxzZSxcbiAgICAgICAgcmVkaXJlY3RNZXNzYWdlOiBudWxsLFxuICAgICAgfSk7XG4gICAgICBleHBlY3QoaXNBY2NvdW50RW1wdHkodG9UZXN0KSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdSZXF1ZXN0cycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGRldGVjdCBhIHJlcXVlc3QnLCAoKSA9PiB7XG4gICAgICBleHBlY3QoYXV0aGVudGljYXRpb24odW5kZWZpbmVkLCB7IHR5cGU6IGF1dGhlbnRpY2F0ZS5wZW5kaW5nLnR5cGUgfSkpLnRvTWF0Y2hPYmplY3Qoe1xuICAgICAgICBsb2FkaW5nOiB0cnVlLFxuICAgICAgfSk7XG4gICAgICBleHBlY3QoYXV0aGVudGljYXRpb24odW5kZWZpbmVkLCB7IHR5cGU6IGdldEFjY291bnQucGVuZGluZy50eXBlIH0pKS50b01hdGNoT2JqZWN0KHtcbiAgICAgICAgbG9hZGluZzogdHJ1ZSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnU3VjY2VzcycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGRldGVjdCBhIHN1Y2Nlc3Mgb24gbG9naW4nLCAoKSA9PiB7XG4gICAgICBjb25zdCB0b1Rlc3QgPSBhdXRoZW50aWNhdGlvbih1bmRlZmluZWQsIHsgdHlwZTogYXV0aGVudGljYXRlLmZ1bGZpbGxlZC50eXBlIH0pO1xuICAgICAgZXhwZWN0KHRvVGVzdCkudG9NYXRjaE9iamVjdCh7XG4gICAgICAgIGxvYWRpbmc6IGZhbHNlLFxuICAgICAgICBsb2dpbkVycm9yOiBmYWxzZSxcbiAgICAgICAgbG9naW5TdWNjZXNzOiB0cnVlLFxuICAgICAgICBzaG93TW9kYWxMb2dpbjogZmFsc2UsXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZGV0ZWN0IGEgc3VjY2VzcyBvbiBnZXQgc2Vzc2lvbiBhbmQgYmUgYXV0aGVudGljYXRlZCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSB7IGRhdGE6IHsgYWN0aXZhdGVkOiB0cnVlIH0gfTtcbiAgICAgIGNvbnN0IHRvVGVzdCA9IGF1dGhlbnRpY2F0aW9uKHVuZGVmaW5lZCwgeyB0eXBlOiBnZXRBY2NvdW50LmZ1bGZpbGxlZC50eXBlLCBwYXlsb2FkIH0pO1xuICAgICAgZXhwZWN0KHRvVGVzdCkudG9NYXRjaE9iamVjdCh7XG4gICAgICAgIGlzQXV0aGVudGljYXRlZDogdHJ1ZSxcbiAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICAgIGFjY291bnQ6IHBheWxvYWQuZGF0YSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBkZXRlY3QgYSBzdWNjZXNzIG9uIGdldCBzZXNzaW9uIGFuZCBub3QgYmUgYXV0aGVudGljYXRlZCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSB7IGRhdGE6IHsgYWN0aXZhdGVkOiBmYWxzZSB9IH07XG4gICAgICBjb25zdCB0b1Rlc3QgPSBhdXRoZW50aWNhdGlvbih1bmRlZmluZWQsIHsgdHlwZTogZ2V0QWNjb3VudC5mdWxmaWxsZWQudHlwZSwgcGF5bG9hZCB9KTtcbiAgICAgIGV4cGVjdCh0b1Rlc3QpLnRvTWF0Y2hPYmplY3Qoe1xuICAgICAgICBpc0F1dGhlbnRpY2F0ZWQ6IGZhbHNlLFxuICAgICAgICBsb2FkaW5nOiBmYWxzZSxcbiAgICAgICAgYWNjb3VudDogcGF5bG9hZC5kYXRhLFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdGYWlsdXJlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZGV0ZWN0IGEgZmFpbHVyZSBvbiBsb2dpbicsICgpID0+IHtcbiAgICAgIGNvbnN0IGVycm9yID0geyBtZXNzYWdlOiAnU29tZXRoaW5nIGhhcHBlbmVkLicgfTtcbiAgICAgIGNvbnN0IHRvVGVzdCA9IGF1dGhlbnRpY2F0aW9uKHVuZGVmaW5lZCwgeyB0eXBlOiBhdXRoZW50aWNhdGUucmVqZWN0ZWQudHlwZSwgZXJyb3IgfSk7XG5cbiAgICAgIGV4cGVjdCh0b1Rlc3QpLnRvTWF0Y2hPYmplY3Qoe1xuICAgICAgICBlcnJvck1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgIHNob3dNb2RhbExvZ2luOiB0cnVlLFxuICAgICAgICBsb2dpbkVycm9yOiB0cnVlLFxuICAgICAgfSk7XG4gICAgICBleHBlY3QoaXNBY2NvdW50RW1wdHkodG9UZXN0KSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGRldGVjdCBhIGZhaWx1cmUnLCAoKSA9PiB7XG4gICAgICBjb25zdCBlcnJvciA9IHsgbWVzc2FnZTogJ1NvbWV0aGluZyBoYXBwZW5lZC4nIH07XG4gICAgICBjb25zdCB0b1Rlc3QgPSBhdXRoZW50aWNhdGlvbih1bmRlZmluZWQsIHsgdHlwZTogZ2V0QWNjb3VudC5yZWplY3RlZC50eXBlLCBlcnJvciB9KTtcblxuICAgICAgZXhwZWN0KHRvVGVzdCkudG9NYXRjaE9iamVjdCh7XG4gICAgICAgIGxvYWRpbmc6IGZhbHNlLFxuICAgICAgICBpc0F1dGhlbnRpY2F0ZWQ6IGZhbHNlLFxuICAgICAgICBzaG93TW9kYWxMb2dpbjogdHJ1ZSxcbiAgICAgICAgZXJyb3JNZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgICAgfSk7XG4gICAgICBleHBlY3QoaXNBY2NvdW50RW1wdHkodG9UZXN0KSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdPdGhlciBjYXNlcycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHByb3Blcmx5IHJlc2V0IHRoZSBjdXJyZW50IHN0YXRlIHdoZW4gYSBsb2dvdXQgaXMgcmVxdWVzdGVkJywgKCkgPT4ge1xuICAgICAgY29uc3QgdG9UZXN0ID0gYXV0aGVudGljYXRpb24odW5kZWZpbmVkLCBsb2dvdXRTZXNzaW9uKCkpO1xuICAgICAgZXhwZWN0KHRvVGVzdCkudG9NYXRjaE9iamVjdCh7XG4gICAgICAgIGxvYWRpbmc6IGZhbHNlLFxuICAgICAgICBpc0F1dGhlbnRpY2F0ZWQ6IGZhbHNlLFxuICAgICAgICBsb2dpblN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBsb2dpbkVycm9yOiBmYWxzZSxcbiAgICAgICAgc2hvd01vZGFsTG9naW46IHRydWUsXG4gICAgICAgIGVycm9yTWVzc2FnZTogbnVsbCxcbiAgICAgICAgcmVkaXJlY3RNZXNzYWdlOiBudWxsLFxuICAgICAgfSk7XG4gICAgICBleHBlY3QoaXNBY2NvdW50RW1wdHkodG9UZXN0KSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHByb3Blcmx5IGRlZmluZSBhbiBlcnJvciBtZXNzYWdlIGFuZCBjaGFuZ2UgdGhlIGN1cnJlbnQgc3RhdGUgdG8gZGlzcGxheSB0aGUgbG9naW4gbW9kYWwnLCAoKSA9PiB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gJ3JlZGlyZWN0IG1lIHBsZWFzZSc7XG4gICAgICBjb25zdCB0b1Rlc3QgPSBhdXRoZW50aWNhdGlvbih1bmRlZmluZWQsIGF1dGhFcnJvcihtZXNzYWdlKSk7XG4gICAgICBleHBlY3QodG9UZXN0KS50b01hdGNoT2JqZWN0KHtcbiAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICAgIGlzQXV0aGVudGljYXRlZDogZmFsc2UsXG4gICAgICAgIGxvZ2luU3VjY2VzczogZmFsc2UsXG4gICAgICAgIGxvZ2luRXJyb3I6IGZhbHNlLFxuICAgICAgICBzaG93TW9kYWxMb2dpbjogdHJ1ZSxcbiAgICAgICAgZXJyb3JNZXNzYWdlOiBudWxsLFxuICAgICAgICByZWRpcmVjdE1lc3NhZ2U6IG1lc3NhZ2UsXG4gICAgICB9KTtcbiAgICAgIGV4cGVjdChpc0FjY291bnRFbXB0eSh0b1Rlc3QpKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgY2xlYXIgYXV0aGVudGljYXRpb24nLCAoKSA9PiB7XG4gICAgICBjb25zdCB0b1Rlc3QgPSBhdXRoZW50aWNhdGlvbih7IC4uLmluaXRpYWxTdGF0ZSwgaXNBdXRoZW50aWNhdGVkOiB0cnVlIH0sIGNsZWFyQXV0aCgpKTtcbiAgICAgIGV4cGVjdCh0b1Rlc3QpLnRvTWF0Y2hPYmplY3Qoe1xuICAgICAgICBsb2FkaW5nOiBmYWxzZSxcbiAgICAgICAgc2hvd01vZGFsTG9naW46IHRydWUsXG4gICAgICAgIGlzQXV0aGVudGljYXRlZDogZmFsc2UsXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0FjdGlvbnMnLCAoKSA9PiB7XG4gICAgbGV0IHN0b3JlO1xuXG4gICAgY29uc3QgcmVzb2x2ZWRPYmplY3QgPSB7IHZhbHVlOiAnd2hhdGV2ZXInIH07XG4gICAgY29uc3QgZ2V0U3RhdGUgPSBqZXN0LmZuKCk7XG4gICAgY29uc3QgZGlzcGF0Y2ggPSBqZXN0LmZuKCk7XG4gICAgY29uc3QgZXh0cmEgPSB7fTtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIHN0b3JlID0gY29uZmlndXJlU3RvcmUoe1xuICAgICAgICByZWR1Y2VyOiAoc3RhdGUgPSBbXSwgYWN0aW9uKSA9PiBbLi4uc3RhdGUsIGFjdGlvbl0sXG4gICAgICB9KTtcbiAgICAgIGF4aW9zLmdldCA9IHNpbm9uLnN0dWIoKS5yZXR1cm5zKFByb21pc2UucmVzb2x2ZShyZXNvbHZlZE9iamVjdCkpO1xuICAgIH0pO1xuXG4gICAgaXQoJ2Rpc3BhdGNoZXMgR0VUX1NFU1NJT05fUEVORElORyBhbmQgR0VUX1NFU1NJT05fRlVMRklMTEVEIGFjdGlvbnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnZXRBY2NvdW50KCkoZGlzcGF0Y2gsIGdldFN0YXRlLCBleHRyYSk7XG5cbiAgICAgIGNvbnN0IHBlbmRpbmdBY3Rpb24gPSBkaXNwYXRjaC5tb2NrLmNhbGxzWzBdWzBdO1xuICAgICAgZXhwZWN0KHBlbmRpbmdBY3Rpb24ubWV0YS5yZXF1ZXN0U3RhdHVzKS50b0JlKCdwZW5kaW5nJyk7XG4gICAgICBleHBlY3QoZ2V0QWNjb3VudC5mdWxmaWxsZWQubWF0Y2gocmVzdWx0KSkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdkaXNwYXRjaGVzIExPR09VVCBhY3Rpb25zJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgc3RvcmUuZGlzcGF0Y2gobG9nb3V0KCkpO1xuICAgICAgZXhwZWN0KHN0b3JlLmdldFN0YXRlKCkpLnRvRXF1YWwoW2V4cGVjdC5hbnkoT2JqZWN0KSwgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcobG9nb3V0U2Vzc2lvbigpKV0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ2Rpc3BhdGNoZXMgQ0xFQVJfQVVUSCBhY3Rpb25zJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgc3RvcmUuZGlzcGF0Y2goY2xlYXJBdXRoZW50aWNhdGlvbignbWVzc2FnZScpKTtcbiAgICAgIGV4cGVjdChzdG9yZS5nZXRTdGF0ZSgpKS50b0VxdWFsKFtleHBlY3QuYW55KE9iamVjdCksIGV4cGVjdC5vYmplY3RDb250YWluaW5nKGF1dGhFcnJvcignbWVzc2FnZScpKSwgY2xlYXJBdXRoKCldKTtcbiAgICB9KTtcblxuICAgIGl0KCdkaXNwYXRjaGVzIExPR0lOLCBHRVRfU0VTU0lPTiBhbmQgU0VUX0xPQ0FMRSBzdWNjZXNzIGFuZCByZXF1ZXN0IGFjdGlvbnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBsb2dpblJlc3BvbnNlID0geyBoZWFkZXJzOiB7IGF1dGhvcml6YXRpb246ICdhdXRoJyB9IH07XG4gICAgICBheGlvcy5wb3N0ID0gc2lub24uc3R1YigpLnJldHVybnMoUHJvbWlzZS5yZXNvbHZlKGxvZ2luUmVzcG9uc2UpKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYXV0aGVudGljYXRlKCd0ZXN0JywgJ3Rlc3QnKShkaXNwYXRjaCwgZ2V0U3RhdGUsIGV4dHJhKTtcblxuICAgICAgY29uc3QgcGVuZGluZ0FjdGlvbiA9IGRpc3BhdGNoLm1vY2suY2FsbHNbMF1bMF07XG4gICAgICBleHBlY3QocGVuZGluZ0FjdGlvbi5tZXRhLnJlcXVlc3RTdGF0dXMpLnRvQmUoJ3BlbmRpbmcnKTtcbiAgICAgIGV4cGVjdChhdXRoZW50aWNhdGUuZnVsZmlsbGVkLm1hdGNoKHJlc3VsdCkpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG4gIH0pO1xuICBkZXNjcmliZSgnY2xlYXJBdXRoVG9rZW4nLCAoKSA9PiB7XG4gICAgbGV0IHN0b3JlO1xuICAgIGNvbnN0IHJlZHVjZXIgPSBjcmVhdGVSZWR1Y2VyKHsgYXV0aGVudGljYXRpb246IHsgYWNjb3VudDogeyBsYW5nS2V5OiAnZW4nIH0gfSB9LCBidWlsZGVyID0+IHtcbiAgICAgIGJ1aWxkZXIuYWRkRGVmYXVsdENhc2UoKCkgPT4ge30pO1xuICAgIH0pO1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgc3RvcmUgPSBjb25maWd1cmVTdG9yZSh7XG4gICAgICAgIHJlZHVjZXIsXG4gICAgICB9KTtcbiAgICB9KTtcbiAgICBpdCgnY2xlYXJzIHRoZSBzZXNzaW9uIHRva2VuIG9uIGNsZWFyQXV0aFRva2VuJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgQVVUSF9UT0tFTl9LRVkgPSAnamhpLWF1dGhlbnRpY2F0aW9uVG9rZW4nO1xuICAgICAgY29uc3QgbG9naW5SZXNwb25zZSA9IHsgaGVhZGVyczogeyBhdXRob3JpemF0aW9uOiAnQmVhcmVyIFRlc3RUb2tlbicgfSB9O1xuICAgICAgYXhpb3MucG9zdCA9IHNpbm9uLnN0dWIoKS5yZXR1cm5zKFByb21pc2UucmVzb2x2ZShsb2dpblJlc3BvbnNlKSk7XG5cbiAgICAgIGF3YWl0IHN0b3JlLmRpc3BhdGNoKGxvZ2luKCd0ZXN0JywgJ3Rlc3QnKSk7XG4gICAgICBleHBlY3QoU3RvcmFnZS5zZXNzaW9uLmdldChBVVRIX1RPS0VOX0tFWSkpLnRvQmUoJ1Rlc3RUb2tlbicpO1xuICAgICAgZXhwZWN0KFN0b3JhZ2UubG9jYWwuZ2V0KEFVVEhfVE9LRU5fS0VZKSkudG9CZSh1bmRlZmluZWQpO1xuICAgICAgY2xlYXJBdXRoVG9rZW4oKTtcbiAgICAgIGV4cGVjdChTdG9yYWdlLnNlc3Npb24uZ2V0KEFVVEhfVE9LRU5fS0VZKSkudG9CZSh1bmRlZmluZWQpO1xuICAgICAgZXhwZWN0KFN0b3JhZ2UubG9jYWwuZ2V0KEFVVEhfVE9LRU5fS0VZKSkudG9CZSh1bmRlZmluZWQpO1xuICAgIH0pO1xuICAgIGl0KCdjbGVhcnMgdGhlIGxvY2FsIHN0b3JhZ2UgdG9rZW4gb24gY2xlYXJBdXRoVG9rZW4nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBBVVRIX1RPS0VOX0tFWSA9ICdqaGktYXV0aGVudGljYXRpb25Ub2tlbic7XG4gICAgICBjb25zdCBsb2dpblJlc3BvbnNlID0geyBoZWFkZXJzOiB7IGF1dGhvcml6YXRpb246ICdCZWFyZXIgVGVzdFRva2VuJyB9IH07XG4gICAgICBheGlvcy5wb3N0ID0gc2lub24uc3R1YigpLnJldHVybnMoUHJvbWlzZS5yZXNvbHZlKGxvZ2luUmVzcG9uc2UpKTtcblxuICAgICAgYXdhaXQgc3RvcmUuZGlzcGF0Y2gobG9naW4oJ3VzZXInLCAndXNlcicsIHRydWUpKTtcbiAgICAgIGV4cGVjdChTdG9yYWdlLnNlc3Npb24uZ2V0KEFVVEhfVE9LRU5fS0VZKSkudG9CZSh1bmRlZmluZWQpO1xuICAgICAgZXhwZWN0KFN0b3JhZ2UubG9jYWwuZ2V0KEFVVEhfVE9LRU5fS0VZKSkudG9CZSgnVGVzdFRva2VuJyk7XG4gICAgICBjbGVhckF1dGhUb2tlbigpO1xuICAgICAgZXhwZWN0KFN0b3JhZ2Uuc2Vzc2lvbi5nZXQoQVVUSF9UT0tFTl9LRVkpKS50b0JlKHVuZGVmaW5lZCk7XG4gICAgICBleHBlY3QoU3RvcmFnZS5sb2NhbC5nZXQoQVVUSF9UT0tFTl9LRVkpKS50b0JlKHVuZGVmaW5lZCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=